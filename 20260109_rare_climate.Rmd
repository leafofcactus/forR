---
title: "20260109-12_rare_climate"
output: html_notebook
---

추린 22종에 생활사 및 종자 분산 형식은 수동으로 넣어서 만들어보자!
아니면 우선적으로 있는지부터 확인해볼까?

```{r}
#공통 종 목록에서 분산형과 생활형이 나와있는지 확인하기####
commonlist <- read.csv("./data/common_trait_list_260105.csv", header = TRUE)
commonspeciesid <- commonlist$AccSpeciesID

trait_selected <- traitdata %>%
  filter(AccSpeciesID %in% commonspeciesid) %>%
  filter(TraitName %in% c("Plant growth form", "Dispersal syndrome", "Leaf area per leaf dry mass (specific leaf area, SLA or 1/LMA): petiole excluded", "Leaf area per leaf dry mass (specific leaf area, SLA or 1/LMA): petiole included", "Leaf area per leaf dry mass (specific leaf area, SLA or 1/LMA): undefined if petiole is in- or excluded", "Leaf dry mass per leaf fresh mass (leaf dry matter content, LDMC)", "Leaf water content per leaf dry mass (not saturated)", "Seed dry mass"))

##다시 피벗테이블 만들기
trait_sel_summary <- trait_selected %>%
  group_by(AccSpeciesName, TraitName) %>%
  summarise(count = n(), .groups = "drop")

# 3. 보기 편하게 Wide-format(가로 형태) 테이블로 변환
# 종이 행(Row)으로, Trait 이름이 열(Column)로 오게 만듭니다.
trait_sel_table_wide <- trait_sel_summary %>%
  tidyr::pivot_wider(names_from = TraitName, values_from = count, values_fill = 0)

# 결과 확인
print(trait_sel_table_wide)

# 1. 숫자 열(형질들)에 대해 값이 0보다 큰 행의 개수만 카운트
total_sel_row <- trait_sel_table_wide %>%
  summarise(across(where(is.numeric), ~ sum(. > 0))) %>%
  mutate(AccSpeciesName = "Total_Species_Count") # 첫 번째 열 이름을 구분하기 쉽게 변경

# 2. 원래 테이블 아래에 합계 행 붙이기
trait_sel_table_final <- bind_rows(trait_sel_table_wide, total_sel_row)

# 확인
tail(trait_sel_table_final)
```

22분류군 중: 종자무게, 생활형은 모두 있고, 분산형은 2개가 부족. 그리고 확인해보니 LDMC가 모두 있어서 leaf water content는 넣지 않아도 될 듯.
근데 데이터 확인해보니 생활형이랑 분산형이 조금 상태가 안좋음.

다시 다 작업함

근데 생각해보니까 만약 흔한 종이랑 유형을 비교하려면, 흔한 종의 유형화 기준도 같아야 하는 거 아님? 그러면 흔한 종도 정보 다운받아서 같이 정리해야 할 듯...?
근데 종이 너무 많아. 이걸 어떻게 해야할까

```{r}
#load occurrence data
library(dplyr)

# 파일 경로와 구분 이름 정의
file_info <- data.frame(
  source = c("nfi_5th", "nfi_4th", "nfi_3rd", "nfi_2nd"),
  path = c(
    "D:/data/전국자연환경조사/전국자연환경조사_5차_2019_2021_전국/식물상/전국자연환경조사_5차_식물상_2019_2021_전국.csv",
    "D:/data/전국자연환경조사/전국자연환경조사_4차_2014_2018_전국/식물상/전국자연환경조사_4차_식물상_2014_2018_전국.csv",
    "D:/data/전국자연환경조사/전국자연환경조사_3차_2006_2013_전국/식물상/전국자연환경조사_3차_식물상_2006_2013_전국.csv",
    "D:/data/전국자연환경조사/전국자연환경조사_2차_1997_2005_전국/식물상/전국자연환경조사_2차_식물상_1997_2005_전국.csv"),
  stringsAsFactors = FALSE
)

# 모든 파일 읽어서 하나의 데이터프레임으로 병합 (출처 정보도 함께)
nfi_data <- do.call(rbind, lapply(1:nrow(file_info), function(i) {
  df <- read.csv(file_info$path[i], header = TRUE)
  df$source <- file_info$source[i]
  df
}))

bdplant <- read.csv("D:/data/국립공원/백두대간정밀조사_2012_2022_전국/백두대간정밀조사_식물상_2015_2022_전국/백두대간정밀조사_식물상_2015_2022_전국_수정.csv")
bdveg <- read.csv("D:/data/국립공원/백두대간정밀조사_2012_2022_전국/백두대간정밀조사_식생_2019_2022_전국/백두대간정밀조사_식생_2019_2022_전국.csv")
tjplant <- read.csv("D:/data/국립공원/특정지역정밀조사_2004_2022_전국/식물상/특정지역정밀조사_식물상_2009_2022_전국.csv")
tjveg <- read.csv("D:/data/국립공원/특정지역정밀조사_2004_2022_전국/식생/특정지역정밀조사_식생_2017_2022_전국.csv")
names(nfi_data)

# 필요한 열 정의
cols_needed <- c("id", "한글보통명", "위도", "경도")

# 각 데이터프레임에서 필요한 열 추출
bdplant_sub <- bdplant[, cols_needed]
bdveg_sub   <- bdveg[, cols_needed]
tjplant_sub <- tjplant[, cols_needed]
tjveg_sub   <- tjveg[, cols_needed]
nfi_sub     <- nfi_data[, cols_needed]

# 병합
combined_data <- rbind(
  bdplant_sub,
  bdveg_sub,
  tjplant_sub,
  tjveg_sub,
  nfi_sub
)

names(combined_data) <- c("X", "국명", "decimalLatitude", "decimalLongitude")

combined_data <- combined_data %>%
  filter(!is.na(국명), trimws(국명) != "")

#filtering occurrence records excluding overseas
library(terra)

r <- rast("./data/terrestrial_250509.tif")

combined_sv <- vect(
  combined_data,
  geom = c("decimalLongitude", "decimalLatitude"),
  crs = "EPSG:4326"   # WGS84
)

inside <- !is.na(extract(r, combined_sv)[,1])
combined_land <- combined_sv[inside, ]
combined_land_df <- as.data.frame(combined_land)

ioccurrence <- table(combined_land_df$국명)

#write.csv(ioccurrence, file = "./data/commonspecies_table_260109.csv")
summary(as.numeric(ioccurrence))

ioccurrence_20 <- ioccurrence[ioccurrence >= 20]

ioccurrence_186 <- ioccurrence[ioccurrence >= 186]
summary(as.numeric(ioccurrence_186))
```

보니까 4020종이래
그래서 값 분포를 보니 20이 중앙값이길래 20미만은 날림
그래도 너무 많아서 그냥 평균값인 186 기준으로 자름
그랬더니 899종임.

TRY에 있는 종은 607분류군.
일단 해당 분류군에 대한 정보 요청함.

*****
TRY Data Request 46438

Only public data were requested.

Title: 46438.

Authors: Jaesang Chung (Seoul National University) PI

Trait List: 42, 28, 3115, 3116, 3117, 47, 26, .

Species List:
75960, 269546, 312660, 31422, 7413, 56313, 49858, 18406, 87092, 41658, 45316, 46875, 56349, 41425, 12609, 33571, 49905,
229604, 227050, 71064, 71370, 45748, 39952, 1142, 332064, 33709, 76721, 47699, 5773, 50489, 371213, 10784, 16208, 33030, 14694, 102167, 64068, 77822, 7061, 33256, 93009, 34657, 9844, 26352, 47847, 20260, 79144, 31019, 5740, 31213, 32481, 101662, 75700, 209294, 39777, 41489, 101024, 216918, 214567, 39426, 408783, 50956, 18529, 51594, 29976, 83182, 71346, 87467, 312702, 42194, 14579, 81876, 33422, 32230, 25134, 17641, 10582, 88321, 34144, 3732, 11112, 440268, 45500, 42600, 3736, 44388, 10528, 21095, 49894, 87890, 16421, 73986, 98468, 77970, 39413, 31529, 77739, 24510, 24528, 72326, 257639, 45971, 88867, 5716, 303340, 10775, 89271, 707, 75662, 51395, 377590, 19225, 55069, 35994, 408781, 20193, 255084, 3700, 34482, 21735, 32660, 76308, 36717, 36152, 70437, 43414, 936, 52293, 56403, 100995, 31619, 86825, 10226, 282273, 71736, 31586, 30393, 101015, 95151, 1130, 11403, 134
 95, 200825, 268329, 57464, 1136, 34679, 257098, 849, 221120, 73952, 275885, 364352, 23921, 14080, 77968, 40430, 857, 73714, 83245, 232223, 10665, 13351, 30296, 13711, 79196, 56315, 52036, 97720, 7385, 71043, 16593, 18408, 234146, 93702, 42440, 49397, 90992, 448446, 68304, 231199, 19722, 9885, 34523, 4403, 87831, 299570, 32039, 4692, 56508, 69777, 43649, 86819, 52246, 45361, 40548, 2833, 30418, 81306, 51013, 43221, 54553, 401042, 340446, 382589, 17512, 14605, 75426, 32040, 297111, 33708, 56733, 41264, 47255, 9839, 73699, 55693, 93028, 1274, 7619, 368808, 56576, 92113, 76319, 216615, 29959, 234720, 254556, 36947, 17510, 93386, 92895, 38669, 101825, 45653, 263040, 53289, 18149, 71550, 203124, 25025, 17919, 382728, 312692, 97401, 76597, 398495, 42086, 11062, 16353, 334270, 97236, 204931, 33596, 48153, 1656, 71584, 329240, 6012, 26138, 47908, 53866, 334578, 346721, 334579, 100949, 51617, 4614, 16144, 56954, 11648, 19919, 19926, 80469, 46985, 876, 278421, 41193, 44818, 55403, 18387, 46303
 , 47261, 56949, 30874, 21203, 19418, 33569, 33012, 5543, 282213, 54889, 57338, 246968, 50917, 38020, 91002, 54489, 23712, 66697, 23265, 5178, 56345, 100064, 293746, 101870, 363269, 99711, 2541, 46992, 14578, 77790, 446243, 87182, 44411, 15102, 29742, 5216, 236285, 92892, 202465, 51372, 9180, 404223, 57436, 56395, 75936, 92543, 71186, 39218, 45312, 56735, 36257, 9526, 80228, 56372, 42805, 33576, 10779, 459559, 39598, 416841, 50584, 334580, 363494, 43667, 26102, 42115, 66429, 39049, 41965, 46710, 20247, 54093, 88074, 53603, 27990, 40703, 32749, 16594, 20927, 25271, 16429, 51618, 43573, 250676, 28404, 46982, 52654, 33929, 47451, 40848, 220611, 34607, 28422, 45434, 442938, 200496, 34618, 15961, 9114, 42798, 43418, 33009, 10296, 36071, 282203, 334572, 56591, 16377, 293722, 78827, 311288, 9833, 55394, 312691, 43142, 35225, 28470, 82914, 56402, 41190, 93261, 376320, 312959, 1365, 41491, 302149, 284273, 35179, 82236, 2714, 235239, 48825, 48235, 12421, 88749, 34155, 32114, 101088, 209266, 20
 139, 47810, 312678, 209268, 101001, 25988, 94052, 401046, 23708, 52628, 16277, 311291, 2176, 295787, 212825, 301501, 379993, 216917, 44555, 211710, 444997, 26098, 12355, 32748, 34141, 237387, 331448, 2237, 1521, 4567, 79635, 9522, 308554, 57609, 448899, 101003, 42137, 26960, 50218, 72152, 92893, 47109, 52, 4045, 75301, 95351, 268630, 56538, 54121, 5199, 406358, 2169, 5268, 33025, 29079, 282593, 56487, 45481, 89281, 32701, 10766, 66406, 64596, 308572, 240594, 39090, 53530, 368823, 57522, 47291, 77832, 11659, 63438, 31610, 37398, 51458, 1140, 33425, 26094, 359822, 293907, 28425, 220383, 46212, 97716, 42514, 1814, 450283, 46762, 54335, 14697, 382357, 88530, 446339, 55468, 18383, 96722, 16409, 23264, 2581, 8459, 92602, 47485, 37964, 33013, 36948, 13407, 51385, 75737, 23274, 54079, 85654, 5533, 24817, 46233, 261973, 50560, 335493, 10388, 9965, 57425, 10865, 14566, 415674, 1278, 32700, 382063, 357599, 230745, 51415, 34652, 46874, 79051, 227849, 332061, 26130, 72022, 311292, 13053, 229427,
  75299, 378587, 51408, 299575, 100976, 228673, 95341, 308574, 7386, 83432, 415133, 101019, 88515, 10520, 272530, 368820, 67031, 17591, 11507, 42884, 11473, 78246, 225366, 89561, 54322, 340479, 25016, 72073, 35056, 46782, 20188, 47806, 14543, 101020, 19411, 23252, 29682, 32470, 10293, 23278, 74780, 34828, 444998, 41191, 101006, 101018,.

Description:

.

*****

2026.01.12

논문을 읽다보니 일반종의 경우 희귀종과 같은 과나 속에 속하는 종만으로 추린 것 같다. 
같은 과에 속하는 종은 122분류군.
이걸 대상으로 해볼까?

그리고 유형화 방법을 찾아야 한다.
왜냐하면 지금 내가 가진건 범주형 데이터도 많기 때문이다.

지금 나뉜 유형

생활사: categorical(Shrub, Tree, Herb)

종자 분산: categorical(anemochory; 바람, autochory; 자가, endozoochory; 포식, epizoochory; 동물 털에 붙어서,  hydrochory; 물, myrmecochory; 개미)

SLA: numeric

LDMC: numeric

seed mass: numeric

어떤 방법을 쓸지 찾다보니 결측치를 채우기 위해 Bayesian hierarchical probabilistic matrix factorization (BHPMF) algorithm을 사용하기도 하는군.
아니면 범주형 변수를 사용할 때 없는 변수가 겹치는 걸 가중치를 줄 수 있기 때문에 변형된 유클리디안 거리+k means 사용
내가 첨 본 논문도 더미 변환 후, k means 사용

그냥 더미 변환을 해보자
종자 분산형 -> 내가 보는 논문에서는 물, 바람, 인간, 동물 으로 해놨는데, 내가 인간은 모두 영향을 줄 수 있다고 생각해 제거했으므로 바람, 자가, 동물, 물로 나누어서 해야할듯.

일반종도 왔다. 같이 넣어서 돌려보자
```{r}
#TRY에서 온 자료 열어보기
library(rtry)

commontraitdata <- rtry_import("./data/46438_12012026084334.repair/46438.txt", separator = "\t",
                         encoding = "Latin-1",
                         quote = "",
                         showOverview = TRUE
)

commonspecieslist <- read.csv("./data/traits/commonspecies_list_260112.csv", header = TRUE)
commonsplist <- commonspecieslist$AccSpeciesID

library(dplyr)

commontraits2 <- commontraitdata %>%
  filter(AccSpeciesID %in% commonsplist)

#write.csv(commontraits2, file = "./data/traits/commonspecies_traits_260112.csv")

```
확인해보니 LDMC가 있는 종이 27분류군에 불과.

