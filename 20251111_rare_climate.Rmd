---
title: "20251111_rare_climate"
output: html_notebook
---

다시 출현자료를 기후빈도에 맞게 올려보자
일단 출현자료부터 불러오자

```{r}
# 출현자료 로드####
library(terra)
library(dplyr)

rast_merged_5179 <- rast("./data/large_landcover_5179.tif")

# 종 발생 데이터 로드
occurrence <- read.csv("./data/occurrence241_250916.csv", header = TRUE)
occurrence <- occurrence[,3:6]

# 좌표 변환 및 셀 ID 추출
occurrence_vect <- vect(occurrence, geom = c("decimalLongitude", "decimalLatitude"), crs = "EPSG:4326")
occurrence_vect_5179 <- project(occurrence_vect, "EPSG:5179")

xy_coords <- crds(occurrence_vect_5179)
cell_ids <- cellFromXY(clm_var_filter, xy_coords)
clm_occ_df <- cbind(occurrence, cell = cell_ids)

# 종별 + 셀별로 중복 제거 (random 1개 유지)
set.seed(42)  # 재현 가능하게
clm_thinned_occ <- clm_occ_df %>%
  group_by(국명, cell) %>%
  slice_sample(n = 1) %>%
  ungroup()
#thinning 결과 4871->3087로 줄어듬..

# 환경 변수 추출
thinned_vect <- vect(clm_thinned_occ, geom = c("decimalLongitude", "decimalLatitude"), crs = "EPSG:4326")
thinned_vect_5179 <- project(thinned_vect, "EPSG:5179")

occ_env <- terra::extract(clm_var_filter, thinned_vect_5179)

thinned_with_env <- cbind(clm_thinned_occ, occ_env[,-1])  # 첫번째(ID) 제외

## EPSG:5179를 데이터프레임에 추가####
# 1. thinned_vect_f_5179 객체에서 5179 좌표를 추출합니다.
coords_5179 <- crds(thinned_vect_5179)
colnames(coords_5179) <- c("X_5179", "Y_5179")

# 2. thinned_with_env 데이터프레임에 5179 좌표를 추가합니다.
thinned_with_env <- cbind(thinned_with_env, coords_5179)

# 6. 마스킹 필터링 준비
thinned_vect_f_5179 <- vect(thinned_with_env, geom = c("X_5179", "Y_5179"), crs = "EPSG:5179")

# 래스터에서 값이 1인 위치만 TRUE로 표시 (mask 생성)
rast_mask <- rast_merged_5179 == 1

# 7. 마스크 값 추출 및 필터링
mask_values <- terra::extract(rast_mask, thinned_vect_f_5179)

# 마스크 값이 1이 아니거나 (마스크 바깥) NA인 경우의 인덱스 찾기
idx <- which(mask_values[,2] != 1 | is.na(mask_values[,2]))

# 마스크 바깥에 있는 데이터만 추출하여 thinned_outside_mask에 할당
thinned_outside_mask <- thinned_with_env[idx, ]

# 결과 확인
# 3087 -> 2956 (데이터의 변화는 기존과 동일하게 유지됩니다.)
unique(thinned_outside_mask$국명) # 241 taxa

# 8. 결과 저장 (X_5179, Y_5179 포함)
# 저장된 CSV 파일에는 decimalLongitude, decimalLatitude 외에 X_5179, Y_5179 열이 추가됩니다.

#write.csv(thinned_outside_mask, "./data/thinned_occur_clm_5179_251016.csv", row.names = FALSE)
```


여기까진 늘 하던 것.
```{r}
library(dplyr)
library(terra) # names(clm_var_filter)를 위해 필요

# 출현자료 PCA 투영####

# 1. PCA 투영에 필요한 환경 변수 데이터 준비
env_vars <- names(clm_var_filter)
thinned_env_data_for_pca <- thinned_outside_mask %>%
  select(all_of(env_vars))

# NA가 포함된 행의 인덱스를 저장 (NA 처리 후 원본 데이터 매칭을 위해 사용)
# 환경 변수에 결측치가 없다고 했으므로, 이 단계는 사실상 전체 행을 처리합니다.
rows_to_keep <- which(apply(is.na(thinned_env_data_for_pca), 1, any) == FALSE)
thinned_env_data_no_na <- na.omit(thinned_env_data_for_pca)

# 2. PCA 변환 적용 및 좌표 조정 (Capping)
occ_scaled <- scale(thinned_env_data_no_na, center = clm_pca_result$center, scale = clm_pca_result$scale)

clm_occ_pca <- as.data.frame(occ_scaled %*% clm_pca_result$rotation) 

# pca_bins의 bin 수준(level) 가져오기
pc1_levels <- levels(pca_bins$PC1_bin)
pc2_levels <- levels(pca_bins$PC2_bin)

# clm_occ_pca에 동일한 수준으로 bin 할당
clm_occ_pca_bins <- clm_occ_pca %>%
  mutate(
    PC1_bin = cut(PC1, breaks = unique(c(as.numeric(sub("\\((.+),.*", "\\1", pc1_levels)), 
                                         as.numeric(sub("[^,]*,([^]]*)\\]", "\\1", pc1_levels)))), 
                  include.lowest = TRUE, labels = pc1_levels),
    PC2_bin = cut(PC2, breaks = unique(c(as.numeric(sub("\\((.+),.*", "\\1", pc2_levels)), 
                                         as.numeric(sub("[^,]*,([^]]*)\\]", "\\1", pc2_levels)))), 
                  include.lowest = TRUE, labels = pc2_levels)
  )
# pca_bins와 join
clm_occ_pca_bins <- clm_occ_pca_bins %>%
  left_join(pca_bins %>% select(PC1_bin, PC2_bin, count_decile),
            by = c("PC1_bin", "PC2_bin"))

# Capping으로 인해 NA는 0개가 되었는지 확인
cat("\n[Capping 후 빈도 10분위별 출현지 개수]\n")
print(table(clm_occ_pca_bins$count_decile, useNA = "ifany"))

```

드디어!!! NA가 사라졌다. 이제 시각화해보자
그런데 간격 값이 일정하지는 않은 것 같다..
일단 지금 꺼로 그려보고 다시 같은 간격값으로 바꿔보자

```{r}
# 출현정보 기후 공간 내 시각화####
library(dplyr)
library(stringr)

pca_bins <- pca_bins %>%
  mutate(
    PC1_start = as.numeric(str_extract(PC1_bin, "(?<=\\()[^,]+")),
    PC1_end = as.numeric(str_extract(PC1_bin, "(?<=,)[^\\]]+")),
    PC2_start = as.numeric(str_extract(PC2_bin, "(?<=\\()[^,]+")),
    PC2_end = as.numeric(str_extract(PC2_bin, "(?<=,)[^\\]]+")),
    PC1_center = (PC1_start+PC1_end)/2,
    PC2_center = (PC2_start+PC2_end)/2
  )

# ggplot을 사용하여 시각화
ggplot(pca_bins, aes(x = PC1_center, y = PC2_center, fill = count_decile)) + # X, Y에 center 좌표 사용
  geom_tile(aes(width = PC1_end - PC1_start, height = PC2_end - PC2_start)) + # 타일의 너비/높이를 빈 크기에 맞춤
  scale_fill_manual(
    values = rev(custom_blues_10), # 10은 높은 빈도, 1은 낮은 빈도에 매핑
    labels = c("하위 10%", "20%", "30%", "40%", "50%", "60%", "70%", "80%", "90%", "상위 10%"),
    name = "기후 빈도 10분위",
    na.value = "grey80" # pca_bins에 혹시 모를 NA가 있다면 회색으로 표시
  ) +
  # thinned_outside_mask_final의 출현 지점 오버레이
  # inherit.aes = FALSE를 사용하여 geom_tile의 aes 설정을 상속받지 않도록 합니다.
  geom_point(data = clm_occ_pca_bins, 
             aes(x = PC1, y = PC2, color = is.na(count_decile)), # X, Y에 원래 PC 좌표 사용
             inherit.aes = FALSE, 
             size = 1.5, 
             alpha = 0.8,
             shape = 16) + # 원형 점
  coord_fixed(ratio = 1) + # PC1과 PC2 축의 비율을 1:1로 고정하여 왜곡 방지
  scale_color_manual(
    values = c("FALSE" = "black", "TRUE" = "red"), # NA가 아니면 검정색, NA이면 빨간색
    labels = c("TRUE" = "분류되지 않음 (NA)", "FALSE" = "분류됨"),
    name = "출현지 분류 여부"
  ) +
  theme_minimal() +
  theme(
    # 축 텍스트를 제거하지 않고, PC1, PC2의 연속적인 값을 표시하도록 변경
    axis.text = element_text(size = 8), 
    axis.ticks = element_line(),
    panel.grid = element_blank() # 격자선 제거
  ) +
  labs(x = "PC1", y = "PC2", 
       title = "PCA 공간의 기후 빈도 10분위 및 종 출현 지점") +
  guides(fill = guide_legend(order = 1), # 빈도 10분위 범례를 먼저 표시
         color = guide_legend(order = 2)) # 출현지 분류 여부 범례를 나중에 표시

```
어떻게든 됐다!
이게 어떤 식물종이 희귀한 기후대에 분포하는지 확인하기 위해 다시 출현정보과 count_decile을 계산해야 한다
```{r}
#분위수 출현정보에 넣기####
# count_decile 벡터 생성 (NA 포함 가능)
count_decile_vec <- clm_occ_pca_bins$count_decile

# 원본 데이터프레임에 count_decile 추가 (NA인 행은 NA 유지)
thinned_outside_mask_with_decile <- thinned_outside_mask %>%
  mutate(count_decile = NA)

thinned_outside_mask_with_decile$count_decile[rows_to_keep] <- count_decile_vec
#write.csv(thinned_outside_mask_with_decile, "./data/thinned_occur_clm_w_decile_5179_251016.csv", row.names = FALSE)

```

이거를 통해 내가 알고 싶은 것은?
기후 빈도 하위 10%에 속하는 것들은 희귀한 기후에만 출현하는 걸까?
아니면 그냥 여러 기후빈도대에 출현하는 걸까?